:_mod-docs-content-type: PROCEDURE

[id="proc-installing-and-configuring-lightspeed_{context}"]
= Installing and configuring {ls-brand-name}

{ls-short} consists of several components which work together to deliver virtual assistant (chat) functionality to your developers. The following list main components:

Llama stack server (container sidecar):: Based on open source https://github.com/llamastack/llama-stack[Llama Stack], this service operates as the main gateway to your LLM inferencing provider for chat services. Its modular architecture supports the integration of other services, such as Model Context Protocol (MCP). To support the chat functionality of {ls-short}, you must integrate your LLM provider with the Llama Stack server. This dependency on external LLM providers is called _Bring Your Own Model_ or BYOM.

{lcs-name} ({lcs-short}) (container sidecar):: Based on the open source https://github.com/lightspeed-core[Lightspeed Core], this service extends the Llama Stack server by providing features such as chat history maintenance and user feedback gathering.

{ls-brand-name} (dynamic plugins):: These plugins are required to enable the {ls-short} user interface within your {product-very-short} instance.

Configuring these components to initialize correctly and communicate with each other is essential in order to provide {ls-short} to your users.

[TIP]
====
If you are upgrading from the previous {ls-short} Developer Preview with Road-Core Service, you must remove all existing {ls-short} configurations and settings before you reinstall.

To prevent or resolve upgrade inconsistencies, first drop and recreate the dynamic plugins volume.

This reinstallation is required due to the following fundamental architectural changes:

* The previous release used Road-Core Service as a sidecar container for interfacing with LLM providers.

* The updated architecture replaces {rcs-short} with the new {lcs-name} and Llama Stack server, which necessitates new configurations for the plugins, volumes, containers, and secrets.
====

.Prerequisites

* You are logged in to your {ocp-short} account.
* You have an {product-very-short} instance installed using either the Operator or the Helm chart.
* You have created a {installing-and-viewing-plugins-book-link}##rhdh-installing-rhdh-plugins_title-plugins-rhdh-about[custom dynamic plugins ConfigMap].

.Procedure

You must manually install and configure the {ls-short} plugin, the {lcs-name} ({lcs-short}) sidecar container, and the Llama Stack sidecar container.

. Create the {lcs-name} ({lcs-short}) ConfigMap: The {lcs-short} ConfigMap stores the configuration for the {lcs-name} and is mounted to the {lcs-short} container.

.. In the {ocp-short} web console, navigate to your {product-very-short} instance and select the *ConfigMaps* tab.
.. Click *Create ConfigMaps*.
.. From the *Create ConfigMap* page, select the *YAML view* option and edit the file using the following structure. This example demonstrates the configuration for the {lcs-short} ConfigMap, typically named `lightspeed-stack`, which connects to the Llama Stack service locally on port `8321`:
+
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: lightspeed-stack
data:
  lightspeed-stack.yaml: |
    name: Lightspeed Core Service (LCS)
    service:
      host: 0.0.0.0
    # Use ${LIGHTSPEED_SERVICE_PORT} if you are not running the Service on port `8080`
    # port: ${LIGHTSPEED_SERVICE_PORT}
      auth_enabled: false
      workers: 1
      color_log: true
      access_log: true
    llama_stack:
      use_as_library_client: false
      url: http://localhost:8321
    user_data_collection:
      feedback_enabled: true
      feedback_storage: "/tmp/data/feedback"
      transcripts_enabled: true
      transcripts_storage: "/tmp/data/transcripts"
    authentication:
      module: "noop"
    conversation_cache:
      type: "sqlite"
      sqlite:
        db_path: "/tmp/data/conversations/lcs_cache.db"
----

.. Click *Create*.

. Create the {ls-short} ConfigMap: Create a dedicated {ls-short} ConfigMap (`lightspeed-app-config`) to hold specific plugin configurations.
.. In the {ocp-short} web console, navigate to your {product-very-short} instance and select the *ConfigMaps* tab.
.. Click *Create ConfigMap*.
.. From the *Create ConfigMap* page, select the *YAML view* option and add the following example:
+
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: lightspeed-app-config
  namespace: <__namespace__> # Enter your RHDH instance namespace
data:
  app-config.yaml: |-
    backend:
      csp:
        upgrade-insecure-requests: false
      img-src:
        - "'self'"
        - "data:"
        - https://img.freepik.com
        - https://cdn.dribbble.com
        - https://avatars.githubusercontent.com # This is to load GitHub avatars in the UI
        script-src:
        - "'self'"
        - "'unsafe-eval'"
        - https://cdn.jsdelivr.net

    lightspeed:
      # OPTIONAL: Custom users prompts displayed to users
      # If not provided, the plugin uses built-in default prompts
      prompts:
        - title: `Getting Started with Red Hat Developer Hub`
          message: Can you guide me through the first steps to start using {product-short} as a developer, like exploring the Software Catalog and adding my service?

      # OPTIONAL: Port for lightspeed service (default: 8080)
      # servicePort: ${LIGHTSPEED_SERVICE_PORT}

      # OPTIONAL: Override default RHDH system prompt
      # systemPrompt: "You are a helpful assistant focused on Red Hat Developer Hub development."
----

.. Click *Create*.

. Create Llama Stack Secret file (`llama-stack-secrets`): This file holds sensitive configuration data for your LLM provider and Llama Stack environment variables.
+
[IMPORTANT]
====
{product} 1.8 configures the Llama Stack image to use the vllm provider exclusively. The vllm provider supports the OpenAI API schema but does not support connecting directly to the official OpenAI service (api.openai.com).
Do not use the official OpenAI API URL or token with vllm in this release. Attempting this might result in errors or improper responses. Native OpenAI provider support is planned for future releases.
====

.. In the {ocp-short} web console, go to *Secrets*.
.. Click *Create* -> *Key/value secret*.
.. In the *Create key/value secret* page, select the *YAML view* option and add the following example:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: llama-stack-secrets
type: Opaque
stringData:
  VLLM_URL: ""
  VLLM_API_KEY: ""
  VLLM_MAX_TOKENS: ""
  VLLM_TLS_VERIFY: ""
  VALIDATION_PROVIDER: ""
  VALIDATION_MODEL_NAME: ""
----
+
where:

`VLLM_URL`:: Required for remote services: Set this to the API endpoint URL of your preferred LLM provider, if it is compatible with the OpenAI API specification (Examples: OpenAI, {rhoai-brand-name}, vLLM)
`VLLM_API_KEY`:: Required for remote services: Set this to the API key or token required for authentication with your remote LLM provider, if it is compatible with the OpenAI API specification
`VLLM_MAX_TOKENS`:: Optional
`VLLM_TLS_VERIFY`:: Optional
//`OLLAMA_URL`:: Set this if you altered the `run.yaml` file to use Ollama
//`OPENAI_API_KEY`:: Set this if you altered the `run.yaml` file. If using `OpenAI` through the generic `VLLM` provider configuration, you must map the API key to `VLLM_API_KEY` instead
`VALIDATION_PROVIDER`:: Set this as `vllm`, `ollama`, `openai`, depending on the key you have set in this configuration file
`VALIDATION_MODEL_NAME`:: Set the name of the model you want to use for validation

.. Click *Create*.

. Update the dynamic plugins ConfigMap: Add the {ls-short} plugin image to your existing dynamic plugins ConfigMap (`dynamic-plugins-rhdh`).
+
[source,yaml]
----
includes:
- dynamic-plugins.default.yaml
plugins:
- package: oci://ghcr.io/redhat-developer/rhdh-plugin-export-overlays/red-hat-developer-hub-backstage-plugin-lightspeed:bs_1.42.5__1.0.3!red-hat-developer-hub-backstage-plugin-lightspeed
  disabled: false
  pluginConfig:
    dynamicPlugins:
      frontend:
        red-hat-developer-hub.backstage-plugin-lightspeed:
          translationResources:
            - importName: lightspeedTranslations
              module: Alpha
              ref: lightspeedTranslationRef
          appIcons:
            - name: LightspeedIcon
              module: LightspeedPlugin
              importName: LightspeedIcon
          dynamicRoutes:
            - path: /lightspeed
              importName: LightspeedPage
              module: LightspeedPlugin
              menuItem:
                icon: LightspeedIcon
                text: Lightspeed
    lightspeed:
      # OPTIONAL: Custom users prompts displayed to users
      prompts:
        - title: 'Getting Started with Red Hat Developer Hub'
          message: Can you guide me through the first steps to start using Developer Hub as a developer, like exploring the Software Catalog and adding my service?
- package: oci://ghcr.io/redhat-developer/rhdh-plugin-export-overlays/red-hat-developer-hub-backstage-plugin-lightspeed-backend:bs_1.42.5__1.0.3!red-hat-developer-hub-backstage-plugin-lightspeed-backend
  disabled: false
----

. Update your deployment configuration: Update the deployment configuration based on how your {product-very-short} instance was installed. You must add two sidecar containers: `llama-stack` and `lightspeed-core`.

** For an Operator-installed {product-very-short} instance (Update {backstage} Custom Resource (CR)):

... In the `spec.application.appConfig.configMaps` section of your {backstage} CR, add the {ls-short} custom app configuration:
+
[source,yaml]
----
appConfig:
  configMaps:
    - name: lightspeed-app-config
----
... Update the `spec.deployment.patch.spec.template.spec.volumes` specification to include volumes for {lcs-short} configuration (`lightspeed-stack`), shared storage for feedback (`shared-storage`), and RAG data (`rag-data-volume`):
+
[source,yaml]
----
volumes:
  - configMap:
      name: lightspeed-stack
    name: lightspeed-stack
  - emptyDir: {}
    name: shared-storage
  - emptyDir: {}
    name: rag-data-volume
----
... Add the `initContainers` section to initialize RAG data:
[source,yaml]
+
----
initContainers:
  - name: init-rag-data
    image: 'quay.io/redhat-ai-dev/rag-content:release-1.8-lcs'
    command:
      - "sh"
      - "-c"
      - "echo 'Copying RAG data...'; cp -r /rag/vector_db/rhdh_product_docs /data/ && cp -r /rag/embeddings_model /data/ && echo 'Copy complete.'"
    volumeMounts:
      - mountPath: /data
        name: rag-data-volume
----
... Add the Llama Stack and the {lcs-short} containers to the `spec.deployment.patch.spec.template.spec.containers` section:
+
[source,yaml]
----
containers:
  # ... Your existing RHDH container definition ...
  - envFrom:
      - secretRef:
          name: llama-stack-secrets
    image: 'quay.io/redhat-ai-dev/llama-stack:0.1.1' # Llama Stack image
    name: llama-stack
    volumeMounts:
      - mountPath: /app-root/.llama
        name: shared-storage
      - mountPath: /app-root/embeddings_model
        name: rag-data-volume
        subPath: embeddings_model
      - mountPath: /app-root/vector_db/rhdh_product_docs
        name: rag-data-volume
        subPath: rhdh_product_docs
  - image: 'quay.io/lightspeed-core/lightspeed-stack:dev-20251021-ee9f08f' # Lightspeed Core Service image
    name: lightspeed-core
    volumeMounts:
      - mountPath: /app-root/lightspeed-stack.yaml
        name: lightspeed-stack
        subPath: lightspeed-stack.yaml
      - mountPath: /tmp/data/feedback
        name: shared-storage
      - mountPath: /tmp/data/transcripts
        name: shared-storage
      - mountPath: /tmp/data/conversations
        name: shared-storage
----
... Click *Save*. The Pods are automatically restarted.

** For a Helm-installed {product-very-short} instance (Update the Helm chart):

... Add your dynamic plugins configuration in the `global.dynamic` property.
... Add your {ls-short} custom app config file to `extraAppConfig`:
+
[source,yaml]
----
    extraAppConfig:
      - configMapRef: lightspeed-app-config
        filename: app-config.yaml
----
... Add the Llama Stack Secret file to `extraEnvVarsSecrets`:
+
[source,yaml]
----
    extraEnvVarsSecrets:
      - llama-stack-secrets
----
... Update the `extraVolumes` section to include the {lcs-short} ConfigMap (`lightspeed-stack`), shared storage, and RAG data volume:
+
[source,yaml]
----
    extraVolumes:
      - configMap:
          name: lightspeed-stack
        name: lightspeed-stack
      - emptyDir: {}
        name: shared-storage
      - emptyDir: {}
        name: rag-data-volume
----
... Update the `initContainers` section (if supported by your Helm chart structure) to initialize RAG data.
+
[source,yaml]
----
  initContainers:
      - name: init-rag-data
        image: 'quay.io/redhat-ai-dev/rag-content:release-1.8-lcs'
        command:
          - "sh"
          - "-c"
          - "echo 'Copying RAG data...'; cp -r /rag/vector_db/rhdh_product_docs /data/ && cp -r /rag/embeddings_model /data/ && echo 'Copy complete.'"
        volumeMounts:
          - mountPath: /data
            name: rag-data-volume
----
... Add the Llama Stack and {lcs-short} container definitions to `extraContainers`
+
[NOTE]
====
If you have Road-Core Service installed from the previous {ls-brand-name} configuration, you must replace the older single container configuration found in source with the two sidecars.
====
+
[source, yaml]
----
    extraContainers:
      # Llama Stack Container
      - envFrom:
          - secretRef:
              name: llama-stack-secrets
        image: 'quay.io/redhat-ai-dev/llama-stack:0.1.1'
        name: llama-stack
        volumeMounts:
          - mountPath: /app-root/.llama
            name: shared-storage
          - mountPath: /app-root/embeddings_model
            name: rag-data-volume
            subPath: embeddings_model
          - mountPath: /app-root/vector_db/rhdh_product_docs
            name: rag-data-volume
            subPath: rhdh_product_docs
      # Lightspeed Core Service Container
      - image: 'quay.io/lightspeed-core/lightspeed-stack:dev-20251021-ee9f08f'
        name: lightspeed-core
        volumeMounts:
          - mountPath: /app-root/lightspeed-stack.yaml
            name: lightspeed-stack
            subPath: lightspeed-stack.yaml
          - mountPath: /tmp/data/feedback
            name: shared-storage
          - mountPath: /tmp/data/transcripts
            name: shared-storage
          - mountPath: /tmp/data/conversations
            name: shared-storage
----
... Click *Save* and then Helm upgrade.

. Optional: Manage authorization (RBAC): If you have users who are not administrators, you must {authorization-book-link}##enabling-and-giving-access-to-rbac[define permissions and roles] for them to use {ls-short}. The Lightspeed Backend plugin uses {backstage} RBAC for authorization.

** For an Operator-installed {product-very-short} instance:

... Configure the required RBAC permission by defining an `rbac-policies.csv` file, including `lightspeed.chat.read`, `lightspeed.chat.create`, and `lightspeed.chat.delete` permissions:
+
[source,csv]
----
p, role:default/_<your_team>_, lightspeed.chat.read, read, allow
p, role:default/_<your_team>_, lightspeed.chat.create, create, allow
p, role:default/_<your_team>_, lightspeed.chat.delete, delete, allow
g, user:default/_<your_user>_, role:default/_<your_team>_
----
... Upload your `rbac-policies.csv` file to an `rbac-policies` ConfigMap in your {ocp-short} project containing {product-very-short} and update your Backstage CR:
+
[source,yaml]
----
apiVersion: rhdh.redhat.com/v1alpha5
kind: Backstage
spec:
  application:
    extraFiles:
      mountPath: /opt/app-root/src
      configMaps:
        - name: rbac-policies
----

** For a Helm-installed {product-very-short} instance:

... Configure the required RBAC permission by defining an `rbac-policies.csv` file:
+
[source,csv]
----
p, role:default/_<your_team>_, lightspeed.chat.read, read, allow
p, role:default/_<your_team>_, lightspeed.chat.create, create, allow
p, role:default/_<your_team>_, lightspeed.chat.delete, delete, allow
g, user:default/_<your_user>_, role:default/_<your_team>_
----
... Optional: Declare policy administrators by editing your custom {product-very-short} ConfigMap (`app-config.yaml`) and adding the following code to enable selected authenticated users to configure RBAC policies through the REST API or Web UI:
+
[source,yaml]
----
  permission:
    enabled: true
    rbac:
      policies-csv-file: /opt/app-root/src/rbac-policies.csv
      policyFileReload: true
    admin:
      users:
        - name: user:default/<your_policy_administrator_name>
----

.Verification

. Log in to your {product-very-short} instance.
. In your {product-very-short} navigation menu, you are able to see and access the *Lightspeed* menu item. Clicking this menu item takes you to the {ls-short} screen.
