:_mod-docs-content-type: PROCEDURE

[id="proc-installing-and-configuring-lightspeed_{context}"]
= Installing and configuring {ls-brand-name}

{ls-short} consists of several components which work together to deliver virtual assistant (chat) functionality to your developers. The following list main components:

* *Llama stack server (container sidecar):* This service (based on open source https://github.com/llamastack/llama-stack[Llama Stack]) operates as the main gateway to your LLM inferencing provider for chat services. It also allows you to integrate other services such as Model Context Protocol (MCP) thanks to its modular nature. You must integrate your LLM provider with the Llama Stack server in order to support the chat functionality of {ls-short}. We call this dependency on external LLM providers _Bring Your Own Model_ or BYOM.

* *{lcs-name} ({lcs-short}) (container sidecar):* This service (based on the open source https://github.com/lightspeed-core[Lightspeed Core]) enables additional features in addition to those that the Llama Stack server provides, such as maintaining your chat history and gathering user feedback.

* *{ls-brand-name} (dynamic plugins):* These plugins are required to enable the {ls-short} user interface within your {product-very-short} instance.

Configuring these components to initialise correctly and communicate with each other is essential in order to provide {ls-short} to your users.

[NOTE]
====
If you have already installed the previous {ls-short} Developer Preview with Road-Core Service, you must remove the previous {ls-short} configurations and settings and reinstall.

This step is necessary as {ls-short} has a new architecture. In the previous release, {ls-short} required the use of the Road-Core Service as a sidecar container for interfacing with LLM providers. The updated architecture removes and replaces {rcs-short} with the new {lcs-name} and Llama Stack server, and requires new configurations for the plugins, volumes, containers, and secrets.
====

.Prerequisites

* You are logged in to your {ocp-short} account.
* You have an existing {product-very-short} instance installed using either the Operator or the Helm chart.

.Procedure

You must manually install and configure the {ls-short} plugin, the {lcs-name} ({lcs-short}) sidecar container, and the Llama Stack sidecar container.

. Create the {lcs-name} ({lcs-short}) ConfigMap: The {lcs-short} ConfigMap stores the configuration for the {lcs-name} and is mounted to the {lcs-short} container.

.. In the {ocp-short} web console, navigate to your {product-very-short} instance and select the *ConfigMaps* tab.
.. Click *Create ConfigMaps*.
.. From the *Create ConfigMap* page, select the *YAML view* option in *Configure via* and edit the file using the following structure. This example demonstrates the configuration for the LCS ConfigMap, typically named `lightspeed-stack`, which connects to the Llama Stack service locally on port `8321`:
+
[source,yaml,subs=+attributes]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: {lcs-name} ({lcs-short})
service:
  host: 0.0.0.0
  port: 8080
  auth_enabled: false
  workers: 1
  color_log: true
  access_log: true
llama_stack:
  use_as_library_client: false
  url: http://localhost:8321
user_data_collection:
  feedback_enabled: true
  feedback_storage: "/tmp/data/feedback"
  transcripts_enabled: true
  transcripts_storage: "/tmp/data/transcripts"
authentication:
  module: "noop"
conversation_cache:
  type: "sqlite"
  sqlite:
    db_path: "./lcs_cache.db"
mcp_servers:
  - name: mcp::backstage
    provider_id: model-context-protocol
    url: https://<{product-very-short}_HOST>/api/mcp-actions/v1
----
+
where:

`{product-very-short}_HOST`:: Enter the hostname for {product-very-short}.
+
[NOTE]
====
The {lcs-short} ConfigMap can optionally include configuration for `mcp_servers` to enable MCP integration.
====

.. Click *Create*.

. Create the {ls-short} ConfigMap: Create a dedicated {ls-short} ConfigMap (`lightspeed-app-config`) to hold specific plugin configurations.

.. In the {ocp-short} web console, navigate to your {product-very-short} instance and select the *ConfigMaps* tab.
.. Click *Create ConfigMap*.
.. From the *Create ConfigMap* page, select the *YAML view* option in *Configure via*, and add the following example:
+
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: lightspeed-app-config
  namespace: <__namespace__> # Enter your {product-very-short} instance namespace
data:
  app-config.yaml: |-
    backend:
      csp:
        upgrade-insecure-requests: false
        img-src:
          - "'self'"
          - "data:"
          - https://img.freepik.com
          - https://cdn.dribbble.com
          - https://avatars.githubusercontent.com # This is to load GitHub avatars in the UI
        script-src:
          - "'self'"
          - https://cdn.jsdelivr.net

    lightspeed:
      mcpServers:
      - name: mcp::backstage
        token: ${MCP_TOKEN}

      # OPTIONAL: Custom users prompts displayed to users
      # If not provided, the plugin uses built-in default prompts
      prompts:
        - title: 'Getting Started with {product}'
          message: Can you guide me through the first steps to start using {product-short} as a developer, like exploring the Software Catalog and adding my service?

      # OPTIONAL: Port for lightspeed service (default: 8080)
      # servicePort: ${LIGHTSPEED_SERVICE_PORT}

      # OPTIONAL: Override default {product-very-short} system prompt
      # systemPrompt: "You are a helpful assistant focused on {product} development."
----

.. Click *Create*.

. Create Llama Stack Secret file: This Secret file holds sensitive configuration data for your LLM provider and Llama Stack environment variables. This secret is typically named `llama-stack-secrets`.

.. In the {ocp-short} web console, go to *Secrets*.
.. Click *Create* -> *Key/value secret*.
.. In the *Create key/value secret* page, select the *YAML view* option in *Configure via*, and add the following example:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: llama-stack-secrets
type: Opaque
stringData:
  VLLM_URL: ""
  VLLM_API_KEY: ""
  VLLM_MAX_TOKENS: ""
  VLLM_TLS_VERIFY: ""
  OLLAMA_URL: ""
  OPENAI_API_KEY: ""
  VALIDATION_PROVIDER: ""
  VALIDATION_MODEL_NAME: ""
----
+
where:

`VLLM_URL`:: Set this if you are using the `redhat-ai-dev` Llama Stack image
`VLLM_API_KEY`:: Set this if you are using the `redhat-ai-dev` Llama Stack image
`VLLM_MAX_TOKENS`:: Optional
`VLLM_TLS_VERIFY`:: Optional
`OLLAMA_URL`:: Set this if you altered the `run.yaml` file
`OPENAI_API_KEY`:: Set this if you altered the `run.yaml` file
`VALIDATION_PROVIDER`:: Set this as `vllm`, `ollama`, `openai`, depending on the key you have set in this configuration file
`VALIDATION_MODEL_NAME`:: Set the name of the model you want to use for validation

.. Click *Create*.

. Update the dynamic plugins ConfigMap: Add the {ls-short} plugin image to your existing dynamic plugins ConfigMap (`dynamic-plugins-{product-very-short}.yaml`).
+
[source,yaml]
----
includes:
- dynamic-plugins.default.yaml
plugins:
- package: oci://ghcr.io/redhat-developer/rhdh-plugin-export-overlays/red-hat-developer-hub-backstage-plugin-lightspeed:next__1.0.1!red-hat-developer-hub-backstage-plugin-lightspeed
  disabled: false
  pluginConfig:
    lightspeed:
      # OPTIONAL: Custom users prompts displayed to users
      prompts:
        - title: 'Getting Started with Red Hat Developer Hub'
          message: Can you guide me through the first steps to start using Developer Hub as a developer, like exploring the Software Catalog and adding my service?
  dynamicPlugins:
    frontend:
      red-hat-developer-hub.backstage-plugin-lightspeed:
        appIcons:
          - name: LightspeedIcon
            module: LightspeedPlugin
            importName: LightspeedIcon
        dynamicRoutes:
          - path: /lightspeed
            importName: LightspeedPage
            module: LightspeedPlugin
            menuItem:
              icon: LightspeedIcon
              text: Lightspeed
- package: oci://ghcr.io/redhat-developer/rhdh-plugin-export-overlays/red-hat-developer-hub-backstage-plugin-lightspeed-backend:next__1.0.1!red-hat-developer-hub-backstage-plugin-lightspeed-backend
  disabled: false
  pluginConfig:
    lightspeed:
      # OPTIONAL: Port for lightspeed service (default: 8080)
      # servicePort: ${LIGHTSPEED_SERVICE_PORT}
----

. Update your deployment configuration: Update the deployment configuration based on how your {product-very-short} instance was installed. You must add two sidecar containers: `llama-stack` and `lightspeed-core`.

** For an Operator-installed {product-very-short} instance (Update {backstage} Custom Resource (CR)):

... In the `spec.application.appConfig.configMaps` section of your {backstage} CR, add the {ls-short} custom app configuration:
+
[source,yaml]
----
    appConfig:
      configMaps:
        - name: lightspeed-app-config
          mountPath: /opt/app-root/src
----
... Update the `spec.deployment.patch.spec.template.spec.volumes` specification to include volumes for {lcs-short} configuration (`lightspeed-stack`), shared storage for feedback (`shared-storage`), and RAG data (`rag-data-volume`):
+
[source,yaml]
----
    volumes:
      - configMap:
          name: lightspeed-stack
        name: lightspeed-stack
      - emptyDir: {}
        name: shared-storage
      - emptyDir: {}
        name: rag-data-volume
----
... Add the `initContainers` section to initialize RAG data:
[source,yaml]
+
----
    initContainers:
      - name: init-rag-data
        image: 'quay.io/redhat-ai-dev/rag-content:release-1.7-lcs'
        command:
          - "sh"
          - "-c"
          - "echo 'Copying RAG data...'; cp -r /rag/vector_db/{product-very-short}_product_docs /data/ && cp -r /rag/embeddings_model /data/ && echo 'Copy complete.'"
        volumeMounts:
          - mountPath: /data
            name: rag-data-volume
----
... Add the Llama Stack and {lcs-short} containers to the `spec.deployment.patch.spec.template.spec.containers` section:
+
[source,yaml]
----
    containers:
      # ... Your existing {product-very-short} container definition ...
      - envFrom:
          - secretRef:
              name: llama-stack-secrets
        image: 'quay.io/redhat-ai-dev/llama-stack:0.1.0' # Llama Stack image
        name: llama-stack
        volumeMounts:
          - mountPath: /app-root/.llama
            name: shared-storage
          - mountPath: /app-root/embeddings_model
            name: rag-data-volume
            subPath: embeddings_model
          - mountPath: /app-root/vector_db/{product-very-short}_product_docs
            name: rag-data-volume
            subPath: rhdh_product_docs
      - image: 'quay.io/lightspeed-core/lightspeed-stack:dev-20251021-ee9f08f' # Lightspeed Core Service image
        name: lightspeed-core
        volumeMounts:
          - mountPath: /app-root/lightspeed-stack.yaml
            name: lightspeed-stack
            subPath: lightspeed-stack.yaml
          - mountPath: /tmp/data/feedback
            name: shared-storage
----
... Click *Save*. The Pods are automatically restarted.

** For a Helm-installed {product-very-short} instance (Update Helm Chart):

... Add your dynamic plugins configuration in the `global.dynamic` property.
... Add your {ls-short} custom app config file to `extraAppConfig`:
+
[source,yaml]
----
    extraAppConfig:
      - configMapRef: lightspeed-app-config
        filename: app-config.yaml
----
... Add the Llama Stack Secret file to `extraEnvVarsSecrets`:
+
[source,yaml]
----
    extraEnvVarsSecrets:
      - llama-stack-secrets
----
... Update the `extraVolumes` section to include the {lcs-short} ConfigMap (`lightspeed-stack`), shared storage, and RAG data volume:
+
[source,yaml]
----
    extraVolumes:
      - configMap:
          name: lightspeed-stack
        name: lightspeed-stack
      - emptyDir: {}
        name: shared-storage
      - emptyDir: {}
        name: rag-data-volume
----
... Update the `initContainers` section (if supported by your Helm chart structure) to initialize RAG data.
+
[source,yaml]
----
  initContainers:
      - name: init-rag-data
        image: 'quay.io/redhat-ai-dev/rag-content:release-1.7-lcs'
        command:
          - "sh"
          - "-c"
          - "echo 'Copying RAG data...'; cp -r /rag/vector_db/{product-very-short}_product_docs /data/ && cp -r /rag/embeddings_model /data/ && echo 'Copy complete.'"
        volumeMounts:
          - mountPath: /data
            name: rag-data-volume
----
... Add the Llama Stack and {lcs-short} container definitions to `extraContainers`
+
[NOTE]
====
You must replace the older single container configuration found in source with the two sidecars.
====
+
[source, yaml]
----
    extraContainers:
      # Llama Stack Container
      - envFrom:
          - secretRef:
              name: llama-stack-secrets
        image: 'quay.io/redhat-ai-dev/llama-stack:0.1.0'
        name: llama-stack
        volumeMounts:
          - mountPath: /app-root/.llama
            name: shared-storage
          - mountPath: /app-root/embeddings_model
            name: rag-data-volume
            subPath: embeddings_model
          - mountPath: /app-root/vector_db/{product-very-short}_product_docs
            name: rag-data-volume
            subPath: rhdh_product_docs
      # Lightspeed Core Service Container
      - image: 'quay.io/lightspeed-core/lightspeed-stack:dev-20251021-ee9f08f'
        name: lightspeed-core
        volumeMounts:
          - mountPath: /app-root/lightspeed-stack.yaml
            name: lightspeed-stack
            subPath: lightspeed-stack.yaml
          - mountPath: /tmp/data/feedback
            name: shared-storage
----
... Click *Save* and then Helm upgrade.

. Manage authorization (RBAC): If you have users who are not administrators, you must define permissions and roles for them to use {ls-short}. The Lightspeed Backend plugin uses {backstage} RBAC for authorization.

** For an Operator-installed {product-very-short} instance:

... Configure the required RBAC permission by defining an `rbac-policies.csv` file, including `lightspeed.chat.read`, `lightspeed.chat.create`, and `lightspeed.chat.delete` permissions:
+
[source,csv]
----
p, role:default/_<your_team>_, lightspeed.chat.read, read, allow
p, role:default/_<your_team>_, lightspeed.chat.create, create, allow
p, role:default/_<your_team>_, lightspeed.chat.delete, delete, allow
g, user:default/_<your_user>_, role:default/_<your_team>_
----
... Upload your `rbac-policies.csv` file to an `rbac-policies` ConfigMap in your {ocp-short} project containing {product-very-short} and update your Backstage CR:
+
[source,yaml]
----
apiVersion: rhdh.redhat.com/v1alpha3
kind: Backstage
spec:
  application:
    extraFiles:
      mountPath: /opt/app-root/src
      configMaps:
        - name: rbac-policies
----

** For a Helm-installed {product-very-short} instance:

... Configure the required RBAC permission by defining an `rbac-policies.csv` file:
+
[source,csv]
----
p, role:default/_<your_team>_, lightspeed.chat.read, read, allow
p, role:default/_<your_team>_, lightspeed.chat.create, create, allow
p, role:default/_<your_team>_, lightspeed.chat.delete, delete, allow
g, user:default/_<your_user>_, role:default/_<your_team>_
----
... Optional: Declare policy administrators by editing your custom {product-very-short} ConfigMap (`app-config.yaml`) and adding the following code to enable selected authenticated users to configure RBAC policies through the REST API or Web UI:
+
[source,yaml]
----
  permission:
    enabled: true
    rbac:
      policies-csv-file: /opt/app-root/src/rbac-policies.csv
      policyFileReload: true
    admin:
      users:
        - name: user:default/<your_policy_administrator_name>
----

.Verification

. Log in to your {product-very-short} instance.
. In your {product-very-short} navigation menu, you are able to see and access the *Lightspeed* menu item. Clicking this menu item takes you to the {ls-short} screen.