:_mod-docs-content-type: PROCEDURE

[id="proc-install-rhdh-orchestrator-airgapped-env-using-helm-chart-full_{context}"]
= Installing {product} with Orchestrator in a fully disconnected {ocp-short} environment using the Helm chart

You can install {product} ({product-very-short}) with the Orchestrator plugin in a fully air-gapped {ocp-short} environment using the Helm chart.

You can mirror images to an intermediary disk, and then mirror from the disk to your target local registry and apply the generated cluster resources.

.Prerequisites

include::snip-installing-the-orchestrator-common-prerequisites.adoc[]

.Procedure

. Create an `ImageSetConfiguration.yaml` file for `oc-mirror`. You must use an `ImageSetConfiguration` file to include all mirrored images required, as shown in the following example:
+
[source,yaml,subs="+attributes,+quotes"]
----
apiVersion: mirror.openshift.io/v2alpha1
kind: ImageSetConfiguration
mirror:
  additionalimages:
  - name: registry.access.redhat.com/rhdh/red-hat-developer-hub-backstage-plugin-orchestrator@_<digest>_
  - name: registry.access.redhat.com/rhdh/red-hat-developer-hub-backstage-plugin-orchestrator-backend@_<digest>_
  - name: registry.access.redhat.com/rhdh/red-hat-developer-hub-backstage-plugin-scaffolder-backend-module-orchestrator@_<digest>_
  - name: registry.access.redhat.com/rhdh/red-hat-developer-hub-backstage-plugin-orchestrator-form-widgets@_<digest>_
  
  helm:
    repositories:
      - name: openshift-charts
        url: https://charts.openshift.io
        charts:
          - name: redhat-developer-hub
            version: "{product-bundle-version}"
          - name: redhat-developer-hub-orchestrator-infra
            version: "{product-bundle-version}"
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v<ocp-version>
     # For example: registry.redhat.io/redhat/redhat-operator-index:v{ocp-version}
      packages:
      - name: logic-operator
        channels:
        - name: stable
          minVersion: {rhoserverless-version}.0
          maxVersion: {rhoserverless-version}.0
      - name: serverless-operator
        channels:
        - name: stable
          minVersion: {rhoserverless-version}
          maxVersion: {rhoserverless-version}
----
+
where:

`<digest>`::
Locate the image digests for your version of {product-very-short} in the `dynamic-plugins.default.yaml` file. You can extract this file from the plugin catalog index image to verify the default settings for your specific release:
+
[source,bash,subs="+attributes,+quotes"]
----
#!/bin/bash

unpack () {
  local IMAGE="$1"
  DIR="${IMAGE//:/_}"
  DIR="/tmp/${DIR//\//-}"
  rm -fr "$DIR"; mkdir -p "$DIR"; container_id=$(podman create "${IMAGE}")
  podman export $container_id -o /tmp/image.tar && tar xf /tmp/image.tar -C "${DIR}/"; podman rm $container_id; rm -f /tmp/image.tar
  echo "Unpacked $IMAGE into $DIR"
  cd $DIR; tree -d -L 3 -I "usr|root|buildinfo"
}

unpack "registry.access.redhat.com/rhdh/plugin-catalog-index:1.9"

# you can then find the `dynamic-plugins.default.yaml` under /tmp/registry.access.redhat.com/rhdh/plugin-catalog-index_1.9/dynamic-plugins.default.yaml
----

. Mirror the images in the `ImageSetConfiguration.yaml` file by running the `oc-mirror` command. For example:
+
[source,terminal,subs="+attributes,+quotes"]
----
$ oc-mirror --config=ImageSetConfiguration.yaml file:///path/to/mirror-archive --authfile /path/to/authfile  --v2
----
+
[NOTE]
====
The `oc-mirror` command pulls the charts listed in the `ImageSetConfiguration` file and makes them available as `tgz` archives under the `/path/to/mirror-archive` directory.
====
+
. Apply the cluster-wide resources generated during the push step to redirect all image pulls to your local registry, as shown in the following example:
+
[source,terminal,subs="+attributes,+quotes"]
----
$ cd <workspace folder>/working-dir/cluster-resources/
$ oc apply -f .
----
+
. Transfer the generated mirror archive file, for example, `/path/to/mirror-archive/mirror_000001.tar`, to a bastion host within your disconnected environment.

. From the bastion host in your disconnected environment, which has access to the mirror registry, mirror the images from the archive file to your target registry. For example:
+
[source,terminal,subs="+attributes,+quotes"]
----
$ oc-mirror --v2 --from <mirror-archive-file> docker://<target-registry-url:port> --workspace file://<workspace folder> --authfile /path/to/authfile
----
+
where:

`<mirror-archive-file>`:: Enter the name of the transferred `tar` file.

`<target-registry-url:port>`:: Enter your local registry, for example, `registry.localhost:5000`.

. Apply the `redhat-developer-hub-orchestrator-infra` Helm chart and approve the install plans. See {installing-in-air-gap-book-link}#assembly-install-rhdh-airgapped-environment-ocp-helm_title-install-rhdh-air-grapped[Air-gapped installation with Helm chart instructions] for details.

. Apply the {product-very-short} {product-version} Helm chart. Include the version {product-bundle-version} and enable the Orchestrator plugin, as shown in the following example:
+
[source,yaml]
----
orchestrator.enabled=true
----

. The {product-very-short} {product-version} Helm chart defaults to pulling Orchestrator plugins from the official {company-name} OCI registry using full URL references. Override this default behavior to point the chart to your local registry.
+
To configure the Orchestrator plugins to use a custom registry, complete the following steps:
+
* Open your `values.yaml` file.
+
* List the Orchestrator plugin packages under the `orchestrator.plugins` section. You must replace the simplified package references with the full URLs that point to your custom OCI registry.
+
[IMPORTANT]
====
You must explicitly include the `pluginConfig` configuration for each plugin as shown in the following example:
====
+
[source,yaml]
----
orchestrator:
  plugins:
    - package: oci://<custom_registry_url>/rhdh/red-hat-developer-hub-backstage-plugin-orchestrator@_<digest>_
      disabled: true
      pluginConfig:
        orchestrator:
          dataIndexService:
            url: http://sonataflow-platform-data-index-service
    - package: oci://<custom_registry_url>/rhdh/red-hat-developer-hub-backstage-plugin-orchestrator-form-widgets@_<digest>_
      disabled: true
      pluginConfig:
        dynamicPlugins:
          frontend:
            red-hat-developer-hub.backstage-plugin-orchestrator-form-widgets: {}
    - package: oci://<custom_registry_url>/rhdh/red-hat-developer-hub-backstage-plugin-orchestrator@_<digest>_
      disabled: true
      pluginConfig:
        dynamicPlugins:
          frontend:
            red-hat-developer-hub.backstage-plugin-orchestrator:
              appIcons:
              - importName: OrchestratorIcon
                name: orchestratorIcon
              dynamicRoutes:
              - importName: OrchestratorPage
                menuItem:
                  icon: orchestratorIcon
                  text: Orchestrator
                  textKey: menuItem.orchestrator
                path: /orchestrator
              entityTabs:
              - path: /workflows
                title: Workflows
                titleKey: catalog.entityPage.workflows.title
                mountPoint: entity.page.workflows
              mountPoints:
              - mountPoint: entity.page.workflows/cards
                importName: OrchestratorCatalogTab
                config:
                  layout:
                  gridColumn: 1 / -1
                  if:
                    anyOf:
                    - IsOrchestratorCatalogTabAvailable
    - package: oci://<custom_registry_url>/rhdh/red-hat-developer-hub-backstage-plugin-scaffolder-backend-module-orchestrator@_<digest>_
      disabled: true
      pluginConfig:
        orchestrator:
          dataIndexService:
            url: http://sonataflow-platform-data-index-service
----
+
where:

`<custom_registry_url>`::
Enter the address of your custom registry where the OCI images have been mirrored.

`<digest>`::
Locate the image digests for your version of {product-very-short} in the `dynamic-plugins.default.yaml` file. You can extract this file from the plugin catalog index image to verify the default settings for your specific release:
+
[source,bash,subs="+attributes,+quotes"]
----
#!/bin/bash

unpack () {
  local IMAGE="$1"
  DIR="${IMAGE//:/_}"
  DIR="/tmp/${DIR//\//-}"
  rm -fr "$DIR"; mkdir -p "$DIR"; container_id=$(podman create "${IMAGE}")
  podman export $container_id -o /tmp/image.tar && tar xf /tmp/image.tar -C "${DIR}/"; podman rm $container_id; rm -f /tmp/image.tar
  echo "Unpacked $IMAGE into $DIR"
  cd $DIR; tree -d -L 3 -I "usr|root|buildinfo"
}

unpack "registry.access.redhat.com/rhdh/plugin-catalog-index:1.9"

# you can then find the dynamic-plugins.default.yaml under /tmp/registry.access.redhat.com/rhdh/plugin-catalog-index_1.9/dynamic-plugins.default.yaml
----

.Verification

* Restart the {product-very-short} Pod and wait for the components to deploy properly.

* After deployment is complete, go to the *{product-very-short}* UI and confirm that the *Orchestrator* UI is accessible and functioning correctly.

[NOTE]
====
The successful accessibility of the Orchestrator UI confirms that the underlying components are running and the cluster recognizes the plugin.
====