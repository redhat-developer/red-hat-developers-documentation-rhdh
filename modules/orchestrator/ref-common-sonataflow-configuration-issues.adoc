:_mod-docs-content-type: REFERENCE

[id="ref-common-sonataflow-configuration-issues_{context}"]
= Common SonataFlow configuration issues

The following are common configuration problems encountered during SonataFlow deployment and direct solutions for verifying persistence and connectivity:

. Workflow installed in a different namespace other than where {product-very-short} Orchestartor infrastructure are deployed and configured fails to start.
+
You can deploy a workflow to a namespace outside the core SonataFlow services. Use the following steps to enable persistence and connectivity for the workflow:

Configure network policies for inter-namespace traffic::

* When deploying a workflow to a namespace outside the core SonataFlow services, you must configure network policies to permit the necessary inter-namespace traffic.
+
The following example shows a `NetworkPolicy` configured to ingress traffic into the workflow namespace:
+
[source,subs="+attributes,+quotes"]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-allow-infra-ns-to-workflow-ns
  # Sonataflow and Workflows are using the {product-very-short} target namespace.
  namespace: {{ .Release.Namespace | quote }}
spec:
  podSelector: {}
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            # Allow knative events to be delivered to workflows.
            kubernetes.io/metadata.name: knative-eventing
      - namespaceSelector:
          matchLabels:
            # Allow auxiliary knative function for workflow (such as m2k-save-transformation)
            kubernetes.io/metadata.name: knative-serving
      - namespaceSelector:
          matchLabels:
            # Allow communication between the serverless logic operator and the workflow namespace.
            kubernetes.io/metadata.name: openshift-serverless-logic
----

* Add SonataFlowClusterPlatform Custom Resource as shown in the following configuration:
+
[source,yaml]
----
oc create -f - <<EOF
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlowClusterPlatform
metadata:
  name: cluster-platform
spec:
  platformRef:
    name: sonataflow-platform
    namespace: $RHDH_NAMESPACE
----

* To allow communication between {product-very-short} namespace and the workflow namespace, add the following network policies:

.. To allow {product-very-short} services to accept traffic from workflows, create an additional network policy within the {product-very-short} instance namespace.
+
[source,yaml]
----
oc create -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-workflows-to-rhdh
  # Namespace where network policies are deployed
  namespace: $RHDH_NAMESPACE
spec:
  podSelector: {}
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            # Allow SonataFlow services to communicate with new/additional workflow namespace.
            kubernetes.io/metadata.name: $ADDITIONAL_WORKFLOW_NAMESPACE
----

.. To allow traffic from {product-very-short}, SonataFlow and Knative, create a network policy within the additional workflow namespace.
+
[source,yaml]
----
oc create -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-rhdh-and-knative-to-workflows
  namespace: $ADDITIONAL_WORKFLOW_NAMESPACE
spec:
  podSelector: {}
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            # Allows traffic from pods in the {product-very-short} namespace.
            kubernetes.io/metadata.name: $RHDH_NAMESPACE
      - namespaceSelector:
          matchLabels:
            # Allows traffic from pods in the Knative Eventing namespace.
            kubernetes.io/metadata.name: knative-eventing
      - namespaceSelector:
          matchLabels:
            # Allows traffic from pods in the Knative Serving namespace.
            kubernetes.io/metadata.name: knative-serving
----

* (Optional) Create an `allow-intra-namespace` policy in the workflow namespace to enable unrestricted communication among all pods within that namespace.

Ensure workflow persistence (If required)::

* Create a dedicated PostgreSQL Secret containing database credentials within the workflow namespace as shown in the following configuration:
+
[source,yaml]
----
oc get secret sonataflow-psql-postgresql -n <your_namespace> -o yaml > secret.yaml
sed -i '/namespace: <your_namespace>/d' secret.yaml
oc apply -f secret.yaml -n $ADDITIONAL_NAMESPACE
----

* Configure the workflow `serviceRef` property to correctly reference the PostgreSQL service namespace using the `namespace: $POSTGRESQL_NAMESPACE` attribute as shown in the following configuration:
+
[source,yaml]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
  ...
spec:
  ...
  persistence:
    postgresql:
      secretRef:
        name: sonataflow-psql-postgresql
        passwordKey: postgres-password
        userKey: postgres-username
      serviceRef:
        databaseName: sonataflow
        databaseSchema: greeting
        name: sonataflow-psql-postgresql
        namespace: $POSTGRESQL_NAMESPACE
        port: 5432
----
+
`namespace`::
Enter the namespace where the PostgreSQL server is deployed.

Identify required namespaces::

* Retrieve the namespace value where {product-very-short} is running using `oc get backstage -A`.

* Identify the SonataFlow Services Namespace by checking for either a `sonataflowclusterplatform` or `sonataflowplatform` instance.
+
[NOTE]
====
By default, the SonataFlow namespace must be the same as the {product-very-short} namespace.
====

. `sonataflow-platform-data-index-service` cannot connect to PostgreSQL database on startup.
+
Diagnose database connection failures by performing the following checks:

.. Make sure the PostgreSQL Pod has fully transitioned to a `running` and operational status.
+
Allow additional time for the database initialization before expecting related service pods (`DataIndex`, `JobService`) to establish a connection.

.. If the PostgreSQL Server operates in a dedicated namespace (for example, outside {product-very-short}), configure network policies to ingress from the SonataFlow services namespace. Network policies might prevent the DataIndex and JobService pods from connecting to the database.