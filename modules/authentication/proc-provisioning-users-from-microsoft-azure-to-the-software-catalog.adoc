:_mod-docs-content-type: PROCEDURE
[id="proc-provisioning-users-from-microsoft-azure-to-the-software-catalog_{context}"]
= Provisioning users from Microsoft Azure to the software catalog

.Prerequisites
* You xref:proc-adding-azure-as-an-authentication-provider_{context}[enabled authentication with Microsoft Azure].

.Procedure

* To enable Microsoft Azure member discovery, edit your custom Developer Hub config map, such as app-config-rhdh, and add following lines to the app-config-rhdh.yaml content:
+
[id=microsoftGraphOrgProviderId]
.`app-config.yaml` fragment with mandatory `microsoftGraphOrg` fields
[source,yaml]
----
dangerouslyAllowSignInWithoutUserInCatalog: false # <1>
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        target: https://graph.microsoft.com/v1.0
        authority: https://login.microsoftonline.com
        tenantId: ${AUTH_AZURE_TENANT_ID}
        clientId: ${AUTH_AZURE_CLIENT_ID}
        clientSecret: ${AUTH_AZURE_CLIENT_SECRET}
----
<1> Allow authentication only for user present in the {product-short} software catalog.

+
Optional: Consider adding following optional fields:
+
[id=queryMode]
`queryMode: basic | advanced`:: By default, the Microsoft Graph API only provides the `basic` feature set for querying.
Certain features require `advanced` querying capabilities.
See link:https://docs.microsoft.com/en-us/graph/aad-advanced-queries[Microsoft Azure Advanced queries].
+
.`app-config.yaml` fragment with optional `queryMode` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        queryMode: advanced
----

`user` block::

[id=userExpand]
`user.expand`:::
To include the expanded resource or collection  referenced by a single relationship (navigation property) in your results.
Only one relationship can be expanded in a single request.
See https://docs.microsoft.com/en-us/graph/query-parameters#expand-parameter[Microsoft Graph query expand parameter].
Can be combined with xref:userGroupMember[] or xref:userFilter[].
+
.`app-config.yaml` fragment with optional `user.expand` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        user:
          expand: manager
----
+
[id=userFilter]
`user.filter`:::
To filter users.
See link:https://docs.microsoft.com/en-us/graph/api/resources/user?view=graph-rest-1.0#properties[Microsoft Graph API] and link:https://docs.microsoft.com/en-us/graph/query-parameters#filter-parameter[Microsoft Graph API query filter parameters syntax].
This and xref:userGroupMemberFilter[] are mutually exclusive, only one can be specified.
+
.`app-config.yaml` fragment with optional `user.filter` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        user:
          filter: accountEnabled eq true and userType eq 'member'
----
+
[id=userLoadPhotos]
`user.loadPhotos: true | false`:::
Load photos by default.
Set to `false` to not load user photos.
+
.`app-config.yaml` fragment with optional `user.loadPhotos` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        user:
          loadPhotos: true # <3>
----
+
[id=userSelect]
`user.select`:::
Define the link:https://docs.microsoft.com/en-us/graph/api/resources/schemaextension?view=graph-rest-1.0[Microsoft Graph resource types] to retrieve.
+
.`app-config.yaml` fragment with optional `user.select` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        user:
          select: ['id', 'displayName', 'description']
----

`userGroupMember` block::
To use group membership to get users.
This and xref:userFilter[] are mutually exclusive, only one can be specified.
See link:https://docs.microsoft.com/en-us/graph/search-query-parameter[].
+
[id="userGroupMemberFilter"]
`userGroupMember.filter`:::
To filter groups and fetch their members.
This and xref:userFilter[] are mutually exclusive, only one can be specified.
+
.`app-config.yaml` fragment with optional `userGroupMember.filter` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        userGroupMember:
          filter: "displayName eq 'Backstage Users'"
----
+
[id="userGroupMemberSearch"]
`userGroupMember.search`:::
To search for groups and fetch their members.
This and xref:userFilter[] are mutually exclusive, only one can be specified.
+
.`app-config.yaml` fragment with optional `userGroupMember.search` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        userGroupMember:
          search: '"description:One" AND ("displayName:Video" OR "displayName:Drive")'
----

`group` block::
To search groups.
+
[id=groupExpand]
`group.expand`:::
Optional parameter to include the expanded resource or collection referenced by a single relationship (navigation property) in your results.
Only one relationship can be expanded in a single request.
See https://docs.microsoft.com/en-us/graph/query-parameters#expand-parameter
Can be combined with xref:userGroupMember[] instead of xref:userFilter[].
+
.`app-config.yaml` fragment with optional `group.expand` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        group:
          expand: member
----
+
[id=groupFilter]
`group.filter`:::
To filter groups.
See link:https://docs.microsoft.com/en-us/graph/api/resources/group?view=graph-rest-1.0#properties[Microsoft Graph API query group syntax].
+
.`app-config.yaml` fragment with optional `group.filter` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        group:
          filter: securityEnabled eq false and mailEnabled eq true and groupTypes/any(c:c+eq+'Unified')
----
+
[id=groupSearch]
`group.search`:::
To search for groups.
See link:https://docs.microsoft.com/en-us/graph/search-query-parameter[Microsoft Graph API query search parameter].
+
.`app-config.yaml` fragment with optional `group.search` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        group:
          search: '"description:One" AND ("displayName:Video" OR "displayName:Drive")'
----
+
[id=groupSelect]
`group.select`:::
To define the link:https://docs.microsoft.com/en-us/graph/api/resources/schemaextension?view=graph-rest-1.0[Microsoft Graph resource types] to retrieve.
+
.`app-config.yaml` fragment with optional `group.select` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        group:
          select: ['id', 'displayName', 'description']
----
+
`schedule` block::
To specify custom schedule.
+
`schedule.frequency`:::
To specify custom schedule frequency.
Supports cron, ISO duration, and "human duration" as used in code.
+
.`app-config.yaml` fragment with optional `schedule.frequency` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        schedule:
          frequency: { hours: 1 }
----
+
`schedule.timeout`:::
To specify custom timeout.
<3> Supports ISO duration and "human duration" as used in code.
+
.`app-config.yaml` fragment with optional `schedule.timeout` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        schedule:
          timeout: { minutes: 50 }
----
+
`schedule.initialDelay`:::
To specify custom initial delay.
Supports ISO duration and "human duration" as used in code.
+
.`app-config.yaml` fragment with optional `schedule.initialDelay` field
[source,yaml]
----
catalog:
  providers:
    microsoftGraphOrg:
      providerId:
        schedule:
          initialDelay: { seconds: 15}
----

.Verification

. Check the console logs to verify the synchronization has been completed.
+
.Successful synchronization example:
[source,json]
----
----

. Log in with a Microsoft Azure account.
