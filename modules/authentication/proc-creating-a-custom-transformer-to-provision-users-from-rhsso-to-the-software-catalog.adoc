[id="provisioning-users-from-rhsso-to-the-software-catalog"]
= Creating a custom transformer to provision users from Red Hat Single-Sign On (RHSSO) to the software catalog

To customize how RHSSO users/groups are mapped into {product} entities, you can create a backend module that utilizes the `keycloakTransformerExtensionPoint` to provide custom user and group transformers to the Keycloak backend.

.Prerequisites
* You xref:provisioning-users-from-rhsso-to-the-software-catalog[enabled provisioning users from Red Hat Single-Sign On (RHSSO) to the software catalog].

.Procedure
. Create a new backend module with the `yarn new` command.

. Add your custom user and group transformers to the `keycloakTransformerExtensionPoint`.

+
Below is an example of how the backend module can be defined:
+
.`plugins/__<module-name>__/src/module.ts`
[source,javascript]
----
/* highlight-add-start */
import {
  GroupTransformer,
  keycloakTransformerExtensionPoint,
  UserTransformer,
} from '@janus-idp/backstage-plugin-keycloak-backend';

const customGroupTransformer: GroupTransformer = async (
  entity,
  realm,
  groups,
) => {
  /* apply transformations */
  return entity;
};
const customUserTransformer: UserTransformer = async (
  entity,
  user,
  realm,
  groups,
) => {
  /* apply transformations */
  return entity;
};
/* highlight-add-end */

export const keycloakBackendModuleTransformer = createBackendModule({
  pluginId: 'catalog',
  moduleId: 'keycloak-transformer',
  register(reg) {
    reg.registerInit({
      deps: {
        /* highlight-add-start */
        keycloak: keycloakTransformerExtensionPoint,
        /* highlight-add-end */
      },
      /* highlight-add-start */
      async init({ keycloak }) {
        keycloak.setUserTransformer(customUserTransformer);
        keycloak.setGroupTransformer(customGroupTransformer);
        /* highlight-add-end */
      },
    });
  },
});
----
+
[IMPORTANT]
====
The `pluginId` for the module **MUST** be set to `catalog` to match the `pluginId` of the `keycloak-backend` or else the module will fail to initialize.
====

. Install this new backend module into your {product-short} backend.

.Verification

* {product-short} imports the users and groups each time when started.
Check the console logs to verify that the synchronization is completed.
+
.Successful synchronization example:
[source,json]
----
{"class":"KeycloakOrgEntityProvider","level":"info","message":"Read 3 Keycloak users and 2 Keycloak groups in 1.5 seconds. Committing...","plugin":"catalog","service":"backstage","taskId":"KeycloakOrgEntityProvider:default:refresh","taskInstanceId":"bf0467ff-8ac4-4702-911c-380270e44dea","timestamp":"2024-09-25 13:58:04"}
{"class":"KeycloakOrgEntityProvider","level":"info","message":"Committed 3 Keycloak users and 2 Keycloak groups in 0.0 seconds.","plugin":"catalog","service":"backstage","taskId":"KeycloakOrgEntityProvider:default:refresh","taskInstanceId":"bf0467ff-8ac4-4702-911c-380270e44dea","timestamp":"2024-09-25 13:58:04"}
----

* After the first import is complete, from the *Catalog* page, you can select **User** to list the users.

* When you select a user, you can see the information imported from RHSSO.

* You can select a group, view the list, and select or view the information imported from RHSSO.

* You can log in with an RHSSO account.
