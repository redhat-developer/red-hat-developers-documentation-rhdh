// Module included in the following assemblies:
//
// * assemblies/assembly-install-rhdh-aks.adoc

[id="proc-deploy-rhdh-instance-aks.adoc_{context}"]
= Deploying the {product-short} instance on {aks-short} with the Operator

.Prerequisites

* A cluster administrator has installed the {product} Operator.
* You have subscribed to `registry.redhat.io`. For more information, see https://access.redhat.com/RegistryAuthentication[{company-name} Container Registry Authentication].
* You have set the context to the {aks-short} cluster in your current `kubeconfig`. For more information, see https://learn.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-cli#connect-to-the-cluster[Connect to the cluster].
* You have installed `kubectl`. For more information, see https://learn.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-install-cli[`az aks install-cli`].

.Procedure

. Create an Image Pull Secret named `rhdh-pull-secret` using your {companyname} credentials to access images from the protected `registry.redhat.io` as shown in the following example:
+
--
[source,bash]
----
kubectl -n <your_namespace> create secret docker-registry rhdh-pull-secret \
    --docker-server=registry.redhat.io \
    --docker-username=<redhat_user_name> \
    --docker-password=<redhat_password> \
    --docker-email=<email>
----
--

. Create an Ingress manifest file, named `rhdh-ingress.yaml`, specifying your {product-short} service name as follows:
+
--
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rhdh-ingress
  namespace: <your_namespace>
spec:
  ingressClassName: webapprouting.kubernetes.azure.com
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: backstage-<your-CR-name>
                port:
                  name: http-backend
----
--

. To deploy the created Ingress, run the following command:
+
--
[source,terminal]
----
kubectl -n <your_namespace> apply -f rhdh-ingress.yaml
----
--

. Create a ConfigMap named `app-config-rhdh` containing the {product-short} configuration using the following example:
+
--
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-rhdh
data:
  "app-config-rhdh.yaml": |
    app:
      title: Red Hat Developer Hub
      baseUrl: https://<app_address>
    backend:
      auth:
        externalAccess:
            - type: legacy
              options:
                subject: legacy-default-config
                secret: "${BACKEND_SECRET}"
      baseUrl: https://<app_address>
      cors:
        origin: https://<app_address>
----
--

. Create a Secret named `{my-product-secrets}` and add a key named `BACKEND_SECRET` with a `Base64-encoded` string value as shown in the following example:
+
--
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: {my-product-secrets}
stringData:
  BACKEND_SECRET: "xxx"
----
--

. Create a Custom Resource (CR) manifest file named `rhdh.yaml` and include the previously created `rhdh-pull-secret` as follows:
+
--
[source,yaml]
----
apiVersion: rhdh.redhat.com/v1alpha3
kind: Backstage
metadata:
  name: <your-rhdh-cr>
spec:
  application:
    imagePullSecrets:
      - rhdh-pull-secret
    appConfig:
      configMaps:
        - name: "app-config-rhdh"
    extraEnvs:
      secrets:
        - name: "{my-product-secrets}"
----
--

. Apply the CR manifest to your namespace:
+
--
[source,terminal]
----
kubectl -n <your_namespace> apply -f rhdh.yaml
----
--

.Verification

Access the deployed {product-short} using the URL: pass:c,a,q[{my-product-url}], where <app_address> is the Ingress address obtained earlier, such as pass:c,a,q[https://108.141.70.228].
