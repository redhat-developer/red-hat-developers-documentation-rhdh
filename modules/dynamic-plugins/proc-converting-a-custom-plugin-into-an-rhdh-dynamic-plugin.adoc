:_mod-docs-content-type: PROCEDURE

[id="proc-converting-a-custom-plugin-into-an-rhdh-dynamic-plugin_{context}"]
= Converting a custom plugin into a dynamic plugin
include::../../modules/dynamic-plugins/proc-custom-plugin-conversion.adoc[leveloffset=+1]

= Convert a custom plugin to a dynamic plugin by using the Plugin Factory
The RHDH Plugin Factory automates the process of converting Backstage plugins into RHDH dynamic plugins.

[WARNING]
The {product-very-short} Plugin Factory is developer preview...

The RHDH Plugin Factory automates the process of converting Backstage plugins into RHDH dynamic plugins. It provides:

Source Repository Management:: Clone and checkout plugin source repositories
Patch & Overlay System:: Apply custom modifications to plugin source code before exporting
Dependency Management:: Automated yarn installation with TypeScript compilation. 
Dynamic Plugin Packaging:: Build, export and package plugins using the RHDH CLI
Container Image Publishing:: Optionally push to container registries (Quay, OpenShift, etc.)

The Dynamic Plug-in Factory is an experimental Developer Preview tool from the Red Hat team that shifts the plug-in build process from an imperative approach to a declarative one. Instead of running a sequence of commands, you define build parameters with configuration files.

The plug-in factory reduces the complexity of the build process by encapsulating many of the developer tools within a container image. When you feed it a configuration, it produces ready-to-deploy plug-in artifacts. This ensures plug-ins are built in a clean, reproducible environment every time, regardless of what version of the Backstage dependencies you have in your local development or continuous integration (CI) environments.

.Prerequisites
* You must install a container engine, for example, Podman or Docker in your environment.

.Procedure
. After you install a container engine, pull the Developer Hub compatible version of the dynamic plugin factory image.
podman pull quay.io/rhdh-community/dynamic-plugins-factory:1.8

. To define the source, create a folder, for example my-plugins ,that contains a config subfolder, and create a .gitignore to avoid committing any secrets.
+
[source,terminal]
----
mkdir -p my-plugins/config
cd my-plugins
echo ".env" >> .gitignore
----
[INFO] The source.json only accepts a single repo. You can build multiple workspaces from a single repository. To build plug-ins from different repositories (e.g., the Backstage Community plug-ins repository and a private internal repository), you will need to create separate config folders for each upstream and run the factory for each config. 
. To specify target plugins, create a plugins-list.yaml to specify exactly which packages should be built and published as dynamic plug-ins:
+
[source,terminal]
----
plugins/entity-feedback:
plugins/entity-feedback-backend: --embed-package @backstage/plugin-notifications-node --embed-package @backstage/plugin-notifications-common
----

In the manual method, you had to run podman login and podman push for every plug-in. The factory automates this process.
Create a .env file in the config directory. This file tells the factory where to push the resulting container images.
+
[source,terminal]
----
# Registry Configuration
REGISTRY_URL=quay.io
REGISTRY_NAMESPACE=your-namespace # usually this is your username or org name
REGISTRY_USERNAME=your-quay-or-robot-username
REGISTRY_PASSWORD=your-quay-or-robot-password
----

[NOTE]
I’m using a robot account with specific write permissions instead of passing my Quay username and password directly to the factory container. Other container registries support similar capabilities. Using a robot account is optional, but recommended when build systems will access Quay.io on your behalf. 

.Run the factory
This is where automation takes over. No need to run yarn install or tsc. Simply run the factory container, mounting the config directory and specifying the target workspace.
Note that we are adding the --push-images flag to tell the factory to push the images to the container registry specified in the .env configuration
+
[source,terminal]
----
podman run --rm -it \
  --device /dev/fuse \
  -v ./config:/config \
  quay.io/rhdh-community/dynamic-plugins-factory:1.8 \
  --push-images \
  --workspace-path=workspaces/entity-feedback
----
+
The container will:
* Clone the repository defined in source.json.
* Install all necessary dependencies in an isolated environment.
* Build the plug-ins listed in plugins-list.yaml.
* Package them and automatically push them to Quay.io.

Once the build is complete, make sure that the new container image repositories are public to avoid the need to configure pull secrets to follow this article. Figure 4 shows where the repository visibility setting is located in Quay.io. 

.Add the plug-ins to Developer Hub
Once the factory has successfully pushed your images to Quay.io, the process for adding them to your Red Hat Developer Hub instance is identical to the manual method.
You will need to update your dynamic-plugins.yaml configuration to point to the new OCI images you just created.
plugins:

[source,yaml]
----
  - package: oci://quay.io/evanshortiss/backstage-community-plugin-entity-feedback:0.9.0!backstage-community-plugin-entity-feedback
    disabled: false
    pluginConfig:
      dynamicPlugins:
        frontend:
          backstage-community.plugin-entity-feedback:
            entityTabs:
              - mountPoint: entity.page.feedback
                path: /feedback
                title: Feedback
            mountPoints:
              - config:
                  layout:
                    gridColumn: 1 / -1
                importName: StarredRatingButtons
                mountPoint: entity.page.feedback/cards
              - config:
                  layout:
                    gridColumn: 1 / -1
                importName: EntityFeedbackResponseContent
                mountPoint: entity.page.feedback/cards
  - package: oci://quay.io/evanshortiss/backstage-community-plugin-entity-feedback-backend:0.11.0!backstage-community-plugin-entity-feedback-backend
    disabled: false
----

.Verification
Once the plug-ins are added to your configuration, restart Developer Hub and confirm they’ve been installed by viewing the container logs and viewing the Installed packages section in the Admin > Extensions view, as shown in Figure 5.
If you are a plug-in developer, you may prefer your own process. If you are a platform engineer tasked with curating a catalog of many different open-source plug-ins for your internal developer portal, the Dynamic Plugin Factory offers a cleaner, more scalable way to manage your supply chain.
